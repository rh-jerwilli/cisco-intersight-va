---
- name: Query server profile assigned to {{ blade_item.Name }}
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ intersight_api_uri }}"
    api_key_id: "{{ intersight_api_key_id }}"
    api_private_key: "{{ (intersight_api_private_key | b64decode) | trim }}"
    resource_path: /server/Profiles
    query_params:
      $filter: "AssignedServer.Moid eq '{{ blade_item.Moid }}'"
      $select: "Name,Moid,AssignedServer,SrcTemplate,Serial"
  register: profiles

- name: Fail if no profile is assigned to {{ blade_item.Name }}
  ansible.builtin.assert:
    that:
      - (profiles.api_response | default([]) | length) > 0
    fail_msg: "No server profile assigned to blade {{ blade_item.Name }}"

- name: Select profile for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    profile: "{{ profiles.api_response[0] }}"
    profile_moid: "{{ profiles.api_response[0].Moid }}"

- name: Query vNICs for profile {{ profile.Name }}
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ intersight_api_uri }}"
    api_key_id: "{{ intersight_api_key_id }}"
    api_private_key: "{{ (intersight_api_private_key | b64decode) | trim }}"
    resource_path: /vnic/EthIfs
    query_params:
      $filter: "Profile.Moid eq '{{ profile_moid }}'"
      $select: "Name,MacAddress,AssignmentMode,Placement,Profile"
  register: _vnics

- name: Choose boot MAC for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    _boot_mac: "{{ (_vnics.api_response | default([]) | map(attribute='MacAddress') | list | first) | default('') }}"

- name: Initialize interfaces list for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    _interfaces_list: []

- name: Append interface MAC for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    _interfaces_list: "{{ _interfaces_list + [ {'macAddress': item.MacAddress} ] }}"
  loop: "{{ _vnics.api_response | default([]) }}"
  loop_control:
    loop_var: item

- name: Build BMC endpoint for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    _bmc_endpoint: "redfish://127.0.0.1/redfish/v1/Systems/System.Embedded.1{{ blade_item.Serial }}"

- name: Lookup optional host IP for {{ blade_item.Name }}
  ansible.builtin.set_fact:
    _host_ip: "{{ intersight_host_ip_map.get(blade_item.Name, '') }}"

- name: Upsert host record for {{ blade_item.Name }} (keyed by name)
  ansible.builtin.set_fact:
    _hosts: >-
      {{
        (
          (_hosts | default([]) | rejectattr('name', 'equalto', blade_item.Name) | list)
          + [
              {
                'name': blade_item.Name,
                'bmcUsername': 'root',
                'bmcPassword': 'password',
                'bmcEndpoint': _bmc_endpoint,
                'bootMACAddress': _boot_mac,
                'interfaces': _interfaces_list,
                'primaryMac': _boot_mac,
                'IP': _host_ip
              }
            ]
        )
      }}

- name: Export host list as job artifacts
  ansible.builtin.set_stats:
    data:
      discovered_hosts: "{{ _hosts }}"