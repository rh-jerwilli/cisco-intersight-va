---
- name: Read Intersight auth from environment (AAP credential injectors)
  ansible.builtin.set_fact:
    intersight_api_key_id: "{{ lookup('env','INTERSIGHT_API_KEY_ID') | default('', true) }}"
    intersight_api_private_key: "{{ lookup('env','INTERSIGHT_API_PRIVATE_KEY') | default('', true) }}"
    intersight_api_uri: "{{ lookup('env','INTERSIGHT_API_URI') | default(intersight_api_uri | default('https://us-east-1.intersight.com/api/v1'), true) }}"

- name: Validate auth is present
  ansible.builtin.assert:
    that:
      - intersight_api_key_id | length > 0
      - intersight_api_private_key | length > 0
    fail_msg: >
      Missing INTERSIGHT_API_KEY_ID and/or INTERSIGHT_API_PRIVATE_KEY.
      Ensure your AAP custom credential injects these environment variables.

- name: Normalize input into one string (handles string OR list)
  ansible.builtin.set_fact:
    _targets_raw: >-
      {{
        (intersight_target_hostnames | join('\n'))
        if (intersight_target_hostnames is sequence and intersight_target_hostnames is not string)
        else (intersight_target_hostnames | string)
      }}

- name: Initialize hostname list/IP map
  ansible.builtin.set_fact:
    intersight_target_hostnames_list: []
    intersight_host_ip_map: {}

- name: Parse input lines (accept Hostname OR Hostname,IP)
  ansible.builtin.set_fact:
    intersight_target_hostnames_list: "{{ intersight_target_hostnames_list + [ _hostname ] }}"
    intersight_host_ip_map: "{{ intersight_host_ip_map | combine(_ip_map) }}"
  vars:
    _line: "{{ item | trim }}"
    _parts: "{{ _line.split(',') }}"
    _hostname: "{{ (_parts[0] | default('') | trim) }}"
    _ip: "{{ (_parts[1] | default('') | trim) }}"
    _ip_map: "{{ (_ip | length > 0) | ternary({ _hostname: _ip }, {}) }}"
  loop: "{{ _targets_raw | replace('\r','\n') | split('\n') }}"
  when:
    - _line | length > 0
    - _hostname | length > 0

- name: Add each hostname (handles newlines, spaces, commas)
  ansible.builtin.set_fact:
    intersight_target_hostnames_list: "{{ intersight_target_hostnames_list + [ item ] }}"
  loop: "{{ (_targets_raw | regex_replace('[\\r\\n,]+', ' ') | regex_replace('\\s+', ' ') | trim).split(' ') }}"
  when: item | length > 0

- name: De-duplicate hostnames
  ansible.builtin.set_fact:
    intersight_target_hostnames_list: "{{ intersight_target_hostnames_list | unique | list }}"


- name: Validate hostname input is non-empty
  ansible.builtin.assert:
    that:
      - intersight_target_hostnames_list | length > 0
    fail_msg: "Paste one blade hostname per line (or comma-separated) into intersight_target_hostnames."

- name: Ensure output directory exists
  ansible.builtin.file:
    path: "{{ intersight_out_dir | default('./out') }}"
    state: directory
    mode: "0750"

- name: Validate hostname input is non-empty
  ansible.builtin.assert:
    that:
      - intersight_target_hostnames_list | length > 0
    fail_msg: "Paste one blade hostname per line into intersight_target_hostnames."

- name: Initialize target blade list and missing list
  ansible.builtin.set_fact:
    _target_blades: []
    _missing_hostnames: []

- name: Debug hostname list (temporary)
  ansible.builtin.debug:
    msg:
      - "type={{ intersight_target_hostnames_list | type_debug }}"
      - "value={{ intersight_target_hostnames_list }}"

- name: Query each blade by hostname (with expand)
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ intersight_api_uri }}"
    api_key_id: "{{ intersight_api_key_id }}"
    api_private_key: "{{ (intersight_api_private_key | b64decode) | trim }}"
    resource_path: /compute/Blades
    query_params:
      $filter: "Name eq '{{ item }}'"
      $select: "Name,Moid,Model,Serial"
  loop: "{{ intersight_target_hostnames_list }}"
  register: _blade_queries

- name: Accumulate found blades and missing hostnames
  ansible.builtin.set_fact:
    _target_blades: >-
      {{
        _target_blades
        + (
            (item.api_response | default([]))[:1]
            if ((item.api_response | default([])) | length > 0)
            else []
          )
      }}
    _missing_hostnames: >-
      {{
        _missing_hostnames
        + (
            [item.item]
            if ((item.api_response | default([])) | length == 0)
            else []
          )
      }}
  loop: "{{ _blade_queries.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Fail if any hostnames are missing
  ansible.builtin.assert:
    that:
      - _missing_hostnames | length == 0
    fail_msg: >
      These hostnames were not found as compute.Blades in Intersight: {{ _missing_hostnames }}.
      Make sure you pasted blade hostnames (not chassis names) and that Intersight inventory is up to date.

- name: Deduplicate target blades by Moid
  ansible.builtin.set_fact:
    _target_blades: "{{ _target_blades | unique(attribute='Moid') | list }}"

- name: Initialize hosts output list
  ansible.builtin.set_fact:
    _hosts: []

- name: Build one host entry per blade
  ansible.builtin.include_tasks: per-blade-payload.yml
  loop: "{{ _target_blades }}"
  loop_control:
    loop_var: blade_item