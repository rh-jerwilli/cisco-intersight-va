---
- name: Read Intersight auth from environment (AAP credential injectors)
  ansible.builtin.set_fact:
    intersight_api_key_id: "{{ lookup('env','INTERSIGHT_API_KEY_ID') | default('', true) }}"
    intersight_api_private_key: "{{ lookup('env','INTERSIGHT_API_PRIVATE_KEY') | default('', true) }}"
    intersight_api_uri: "{{ lookup('env','INTERSIGHT_API_URI') | default(intersight_api_uri | default('https://us-east-1.intersight.com/api/v1'), true) }}"

- name: Validate auth is present
  ansible.builtin.assert:
    that:
      - intersight_api_key_id | length > 0
      - intersight_api_private_key | length > 0
    fail_msg: >
      Missing INTERSIGHT_API_KEY_ID and/or INTERSIGHT_API_PRIVATE_KEY.
      Ensure your AAP custom credential injects these environment variables.

- name: Normalize hostnames (AAP passes block scalar string)
  ansible.builtin.set_fact:
    intersight_target_hostnames: "{{ (intersight_target_hostnames | default('') | string).split('\n') }}"

# - name: De-duplicate hostnames (after normalization)
#   ansible.builtin.set_fact:
#     intersight_target_hostnames: "{{ intersight_target_hostnames | unique }}"

- name: Debug hostnames right before API work (temporary)
  ansible.builtin.debug:
    msg:
      - "type={{ intersight_target_hostnames | type_debug }}"
      - "value={{ intersight_target_hostnames }}"


- name: Ensure output directory exists
  ansible.builtin.file:
    path: "{{ intersight_out_dir | default('./out') }}"
    state: directory
    mode: "0750"

- name: Normalize hostnames (AAP passes block scalar string)
  ansible.builtin.set_fact:
    intersight_target_hostnames: >-
      {{
        (intersight_target_hostnames | default('') | string)
        .split('\n')
        | map('trim')
        | select('ne','')
        | list
      }}

- name: Validate hostname input is non-empty
  ansible.builtin.assert:
    that:
      - intersight_target_hostnames | length > 0
    fail_msg: "Paste one blade hostname per line into intersight_target_hostnames."

- name: Initialize target blade list and missing list
  ansible.builtin.set_fact:
    _target_blades: []
    _missing_hostnames: []

- name: Build authoritative hostname list for looping
  ansible.builtin.set_fact:
    intersight_target_hostnames_list: >-
      {{
        (
          (intersight_target_hostnames | default('') | string).split('\n')
          | map('trim')
          | select('ne','')
          | list
        )
        | to_json | from_json
      }}

- name: Debug hostname list (temporary)
  ansible.builtin.debug:
    msg:
      - "type={{ intersight_target_hostnames_list | type_debug }}"
      - "value={{ intersight_target_hostnames_list }}"

- name: Query each blade by hostname
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ intersight_api_uri }}"
    api_key_id: "{{ intersight_api_key_id }}"
    api_private_key: "{{ (intersight_api_private_key | b64decode) | trim }}"
    resource_path: /compute/Blades
    query_params:
      $filter: "Name eq '{{ item }}'"
      $select: "Name,Moid,Model,Serial"
  loop: "{{ intersight_target_hostnames_list }}"
  loop_control:
    label: "{{ item }}"
  register: _blade_queries

- name: Accumulate found blades and missing hostnames
  ansible.builtin.set_fact:
    _target_blades: >-
      {{
        _target_blades
        + (
            (item.api_response | default([]))[:1]
            if ((item.api_response | default([])) | length > 0)
            else []
          )
      }}
    _missing_hostnames: >-
      {{
        _missing_hostnames
        + (
            [item.item]
            if ((item.api_response | default([])) | length == 0)
            else []
          )
      }}
  loop: "{{ _blade_queries.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Fail if any hostnames are missing
  ansible.builtin.assert:
    that:
      - _missing_hostnames | length == 0
    fail_msg: >
      These hostnames were not found as compute.Blades in Intersight: {{ _missing_hostnames }}.
      Make sure you pasted blade hostnames (not chassis names) and that Intersight inventory is up to date.

- name: Build one host entry per blade
  ansible.builtin.include_tasks: per-blade-payload.yml
  loop: "{{ _target_blades }}"
  loop_control:
    loop_var: blade_item