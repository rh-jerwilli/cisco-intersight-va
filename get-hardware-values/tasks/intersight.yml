---
- name: Resolve Intersight connection/auth vars (AAP env injectors preferred)
  ansible.builtin.set_fact:
    _intersight_api_uri: "{{ lookup('env','INTERSIGHT_API_URI') | default(intersight_api_uri | default('https://us-east-1.intersight.com/api/v1'), true) }}"
    _intersight_api_key_id: "{{ lookup('env','INTERSIGHT_API_KEY_ID') | default(intersight_api_key_id | default(''), true) }}"
    _intersight_api_private_key: "{{ lookup('env','INTERSIGHT_API_PRIVATE_KEY') | default(intersight_api_private_key | default(''), true) }}"
    _intersight_hostname: >-
      {{
        (intersight_target_hostname | default('', true) | length > 0)
        | ternary(intersight_target_hostname, (lookup('env','INTERSIGHT_HOSTNAME') | default('', true)))
      }}

- name: Validate Intersight credentials are present
  ansible.builtin.assert:
    that:
      - _intersight_api_key_id | length > 0
      - _intersight_api_private_key | length > 0
    fail_msg: >
      Missing Intersight credentials. Ensure AAP injects INTERSIGHT_API_KEY_ID and
      INTERSIGHT_API_PRIVATE_KEY (PEM contents), or set intersight_api_key_id/intersight_api_private_key.

- name: Ensure output directory exists
  ansible.builtin.file:
    path: "{{ intersight_out_dir | default('./out') }}"
    state: directory
    mode: "0750"

# ----------------------------
# Target selection
# ----------------------------
- name: Query blade by hostname (if provided)
  when: _intersight_hostname | length > 0
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ _intersight_api_uri }}"
    api_key_id: "{{ _intersight_api_key_id }}"
    api_private_key: "{{ _intersight_api_private_key }}"
    resource_path: /compute/Blades
    query_params:
      $filter: "Name eq '{{ _intersight_hostname }}'"
      $select: "Name,Moid,Model,Serial"
  register: _blades

- name: Discover blades (if hostname not provided)
  when: _intersight_hostname | length == 0
  cisco.intersight.intersight_rest_api:
    return_list: true
    api_uri: "{{ _intersight_api_uri }}"
    api_key_id: "{{ _intersight_api_key_id }}"
    api_private_key: "{{ _intersight_api_private_key }}"
    resource_path: /compute/Blades
    query_params:
      $top: "{{ intersight_discover_top | default(200) }}"
      $select: "Name,Moid,Model,Serial"
  register: _blades

- name: Build target_blades list (apply regex only in discovery mode)
  ansible.builtin.set_fact:
    _target_blades: >-
      {{
        (
          (_blades.api_response | default([]))
          if (_intersight_hostname | length > 0)
          else
          ((_blades.api_response | default([])) | selectattr('Name','match', (intersight_discover_name_regex | default('.*'))) | list)
        )
      }}

- name: Fail if no blades matched
  ansible.builtin.assert:
    that:
      - _target_blades | length > 0
    fail_msg: >
      No blades matched. If using hostname, verify the Name in Intersight.
      If discovering, increase intersight_discover_top or adjust intersight_discover_name_regex.

# ----------------------------
# Per-blade processing
# ----------------------------
- name: Initialize aggregated values list
  ansible.builtin.set_fact:
    intersight_generated_values: []

- name: Process blades
  ansible.builtin.include_tasks: per_blade.yml
  loop: "{{ _target_blades }}"
  loop_control:
    loop_var: blade_item

- name: Write combined values file
  when: intersight_write_combined_file | default(true) | bool
  ansible.builtin.copy:
    dest: "{{ intersight_out_dir | default('./out') }}/values_all.yml"
    content: "{{ intersight_generated_values | to_nice_yaml(indent=2) }}"